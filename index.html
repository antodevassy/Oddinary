<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oddinary</title>
    <link rel="icon" type="image/png" href="fav-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette */
            --bg-dark: #0E0F13;
            --bg-card: #181A20;
            --primary: #6BCF2D;
            --primary-glow: #9CFF3A;
            --danger: #D93A3A;
            --danger-glow: #8E1E1E;
            --accent-gold: #C9A45D;
            --accent-light: #E6C48A;
            --text-main: #F2F2F2;
            --text-sec: #B6B8C0;
            --text-muted: #6C6F78;

            /* Effects */
            --shadow-card: 0 10px 30px rgba(0,0,0,0.5);
            --glow-primary: 0 0 20px rgba(107, 207, 45, 0.3);
            --glow-danger: 0 0 20px rgba(217, 58, 58, 0.3);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* Prevent scroll */
            display: flex;
            flex-direction: column;
            text-align: center; /* Global center text */
        }

        /* Typography */
        h1, h2, h3 { font-weight: 900; letter-spacing: -0.5px; }
        .text-glow { text-shadow: 0 0 15px rgba(156, 255, 58, 0.5); }
        .text-danger { color: var(--danger); text-shadow: 0 0 15px rgba(217, 58, 58, 0.5); }
        .text-gold { color: var(--accent-gold); }
        
        /* Layout Containers */
        #app {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            animation: fadeIn 0.4s ease-out;
            /* Central Layout Logic */
            justify-content: center; 
            align-items: center;
            gap: 15px; /* Consistent gap between Header, Content, Buttons */
        }
        .screen.active { display: flex; }

        .content-area {
            flex-shrink: 1; /* Allow shrinking if needed */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-y: auto;
            /* padding: 10px 0; */
            justify-content: center; /* Center vertical */
            text-align: center; /* Center text */
        }

        /* Specific fix for Reveal Screen scrollbar */
        #screen-reveal .content-area {
            overflow: hidden !important; /* Force no scroll during animation */
        }

        /* Components */
        .btn {
            background: var(--bg-card);
            color: var(--text-main);
            border: 2px solid var(--text-muted);
            padding: 18px;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 100%;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            /* Center text in button */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary {
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            box-shadow: var(--glow-primary);
        }
        .btn-primary:hover {
            background: var(--primary-glow);
            box-shadow: 0 0 30px rgba(156, 255, 58, 0.6);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
            box-shadow: var(--glow-danger);
        }
        
        .btn-icon {
            width: 50px; /* Square button */
            padding: 0;
            display: flex;
            justify-content: center; /* Center icon */
            align-items: center;
            margin-left: 10px;
            /* color: var(--danger);  REMOVED to inherit white from btn-danger */
            border-color: var(--danger);
            margin-bottom: 0; /* Align with input */
        }

        .btn-icon svg {
             width: 24px;
             height: 24px;
             fill: currentColor;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .input-group {
            width: 100%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center; /* Center content */
            animation: slideIn 0.3s ease;
        }

        input {
            flex: 1;
            background: var(--bg-card);
            border: 2px solid var(--text-muted);
            padding: 15px;
            border-radius: var(--radius);
            color: white;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.2s;
            text-align: center; /* Center input text */
        }
        input:focus { border-color: var(--primary); box-shadow: var(--glow-primary); }

        .card-container {
            perspective: 1000px;
            width: 100%;
            max-width: 350px;
            height: 400px;
            margin: 20px auto; 
            cursor: pointer;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 24px;
        }

        .card.flipped { transform: rotateY(180deg); }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg-card);
            border: 2px solid var(--text-muted);
            border-radius: 24px;
            box-shadow: var(--shadow-card);
            padding: 30px;
            text-align: center;
        }

        .card-front {
            background: linear-gradient(145deg, var(--bg-card), #22252b);
            border-color: var(--primary);
        }

        .card-back {
            background: var(--bg-card);
            transform: rotateY(180deg);
            border: 2px solid var(--primary);
            box-shadow: inset 0 0 50px rgba(107, 207, 45, 0.1);
        }

        .list-item {
            background: var(--bg-card);
            padding: 15px 25px; /* Added horizontal padding */
            border-radius: var(--radius);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between; /* WIDE separation */
            align-items: center;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.05);
            text-align: center;
        }

        .logo-img {
            width: 100%; 
            max-width: 600px; /* Even Bigger */
            height: auto;
            margin-bottom: -10px; /* NEGATIVE margin to pull buttons up */
            filter: drop-shadow(0 0 25px rgba(107, 207, 45, 0.4));
        }

        /* Vote Bar Animation */
        .vote-bar-container {
            width: 100%;
            height: 40px;
            background: #252830;
            border-radius: 20px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }
        .vote-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 1s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .vote-count-text {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: white;
            text-shadow: 0 0 4px rgba(0,0,0,0.8);
        }

        /* Footer */
        .footer-copyright {
            padding: 10px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            width: 100%;
            /* Not pushing to bottom anymore, just part of flow */
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(107, 207, 45, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 30px rgba(107, 207, 45, 0); }
            100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(107, 207, 45, 0); }
        }

        .pulse-anim {
            width: 100px; height: 100px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 4px solid var(--primary);
            display: flex; justify-content: center; align-items: center;
            font-size: 3rem;
            margin: 40px auto;
            animation: pulse-ring 2s infinite;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .text-c { text-align: center; }
        .mb-2 { margin-bottom: 20px; }
        .mt-2 { margin-top: 20px; }
        .badge {
            background: #333;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-sec);
        }

        .switch-container {
            display: flex;
            justify-content: center; /* Centered items */
            gap: 20px; /* Spacing */
            align-items: center;
            width: 100%;
            margin-bottom: 12px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: var(--radius);
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 20px; width: 20px;
            left: 4px; bottom: 4px;
            background-color: white; transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(14,15,19,0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none; /* Default hidden */
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.open { display: flex; animation: fadeIn 0.3s ease-out; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem !important; }
            h2 { font-size: 1.5rem !important; }
            h3 { font-size: 1.1rem !important; }
            
            .btn {
                padding: 14px;
                font-size: 1rem;
                border-width: 1px;
            }
            
            .input-group input { padding: 12px; font-size: 1rem; }
            .btn-icon { width: 44px; }
            
            .card-container {
                height: 340px;
                max-width: 280px;
            }
            .card-face h1 { font-size: 2rem !important; }
            
            .pulse-anim { width: 80px; height: 80px; font-size: 2.2rem; }
            .vote-bar-container { height: 32px; }
            .vote-count-text { font-size: 0.9rem; }
            
            .list-item { padding: 12px 15px; }
            .list-item span { font-size: 1rem !important; }

            /* Ensure highlight text scales but stays relatively large */
            #voter-name { font-size: 2rem !important; }
            #confirm-vote-name { font-size: 1.3rem !important; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- 1. Landing Screen -->
    <div id="screen-landing" class="screen active">
        <!-- Center Stack -->
        <img src="logo.png" alt="Oddinary" class="logo-img" onerror="this.src='';this.innerHTML='<h1>Oddinary</h1>'">
        
        <div style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <button class="btn btn-primary" onclick="Game.goToSetup()">Start Game</button>
            <button class="btn" onclick="Game.toggleRules()">How to Play?</button>
            
            <h3 class="text-muted text-c mt-2 mb-2" style="font-size: 0.9rem;">GAME SETTINGS</h3>
            
            <div class="switch-container">
                <span>Shuffle Player Order</span>
                <label class="switch">
                    <input type="checkbox" id="setting-shuffle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="switch-container">
                <span>Discussion Timer (3 mins)</span>
                <label class="switch">
                    <input type="checkbox" id="setting-timer">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        
        <div class="footer-copyright">¬© Anto Devassy V.P</div>
    </div>

    <!-- How To Play Modal Overlay -->
    <div id="modal-rules" class="modal">
        <div style="max-width: 500px; width: 100%;">
            <h2 class="text-primary mb-2 text-c">How to Play?</h2>
            <div style="text-align: center; line-height: 1.6; color: var(--text-sec); display: flex; flex-direction: column; align-items: center;">
                <p class="mb-2">1. Everyone gets a secret word.</p>
                <p class="mb-2">2. <strong>One player</strong> gets a slightly different word (The Imposter).</p>
                <p class="mb-2">3. Describe your word without revealing it directly.</p>
                <p class="mb-2">4. Vote for who you think is the Imposter!</p>
                <p class="mb-2 text-gold">If the Imposter is caught, they lose... unless they can guess the common word!</p>
            </div>
            <button class="btn btn-primary mt-2" onclick="Game.toggleRules()">Got it</button>
        </div>
    </div>

    <!-- 2. Player Setup -->
    <div id="screen-setup" class="screen">
        <h2 class="text-c" style="margin-bottom: 20px;">PLAYERS LIST</h2>
        
        <!-- List Container -->
        <div id="players-list" style="width: 100%; max-height: 60vh; overflow-y: auto;">
            <!-- Dynamic Inputs -->
        </div>
        
        <button class="btn" onclick="Game.addPlayer()" style="border-style: dashed; margin-top: 5px;">+ Add Player</button>
        
        <!-- Action Buttons Flowing Directly Below -->
        <div style="width: 100%; margin-top: 20px;">
            <button class="btn btn-primary" onclick="Game.startGame()">Start</button>
            <button class="btn" onclick="Game.goHome()">Back</button>
        </div>
    </div>

    <!-- 3. Word Reveal (Pass N Play) -->
    <div id="screen-reveal" class="screen">
        <div class="content-area">
            <h3 class="text-muted">Pass device to</h3>
            <h1 id="reveal-player-name" class="text-primary mb-2" style="font-size: 2.5rem;">Player Name</h1>
            
            <p id="reveal-counter" class="text-muted" style="margin-bottom: 10px;">Player 1/3</p>
            
            <div class="card-container" onclick="Game.flipCard()">
                <div class="card" id="word-card">
                    <div class="card-face card-front">
                        <span style="font-size: 3rem;">üïµÔ∏è</span>
                        <h3>Tap to Reveal</h3>
                        <p class="text-muted">Keep it secret!</p>
                    </div>
                    <div class="card-face card-back">
                        <p class="text-muted">Your secret word is</p>
                        <h1 id="secret-word-display" style="font-size: 2.5rem; color: var(--primary);">WORD</h1>
                    </div>
                </div>
            </div>
        </div>
        <button id="btn-next-player" class="btn btn-primary hidden" onclick="Game.nextReveal()">Hide & Pass</button>
    </div>

    <!-- 4. Discussion Phase -->
    <div id="screen-discuss" class="screen">
        <div class="content-area">
            <div class="pulse-anim">üó£Ô∏è</div>
            <h1 class="text-gold mb-2">Discuss!</h1>
            <p class="text-c text-muted mb-2">Describe your word, but don't say it. Find out who is the imposter.</p>
            
            <div id="timer-display" class="hidden" style="font-size: 3rem; font-weight: 900; color: var(--text-main); margin: 30px 0;">
                03:00
            </div>
        </div>
        <button class="btn btn-primary" onclick="Game.startVoting()">Start Voting</button>
    </div>

    <!-- 5. Voting Phase -->
    <div id="screen-voting" class="screen">
        <h3 class="text-c text-muted">Pass to</h3>
        <h1 id="voter-name" class="text-primary mb-2" style="font-size: 2.5rem;">Player</h1>
        <h2 class="text-c mb-2">Who is the Imposter?</h2>
        
        <div class="content-area" id="voting-list">
            <!-- Voting Buttons -->
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal-vote-confirm" class="modal">
        <div style="max-width: 400px; width: 100%; text-align: center;">
            <h2 class="text-white mb-2">Confirm Vote?</h2>
            <p class="text-muted mb-2">Are you sure you want to vote for: <span id="confirm-vote-name" class="text-primary" style="display: block; font-size: 1.5rem; font-weight: 900; margin-top: 10px;">Player</span></p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" style="flex:1" onclick="Game.cancelVote()">Cancel</button>
                <button class="btn btn-danger" style="flex:1" onclick="Game.confirmVote()">Vote</button>
            </div>
        </div>
    </div>

    <!-- 6. Results -->
    <div id="screen-results" class="screen">
        <div class="content-area" id="results-area">
            <!-- Dynamic Results -->
        </div>
        
        <h3 id="imposter-reveal-text" class="text-c text-danger mb-2"></h3>

        <div style="background: var(--bg-card); padding: 15px; border-radius: var(--radius); width: 100%; margin-bottom: 15px;">
           <div style="display:flex; justify-content:center; gap: 20px; align-items:center;">
             <span class="text-muted">Common Word:</span>
             <strong id="res-common-word" class="text-primary">Word</strong>
           </div>
           <div style="display:flex; justify-content:center; gap: 20px; align-items:center; margin-top: 10px;">
             <span class="text-muted">Odd Word:</span>
             <strong id="res-odd-word" class="text-danger">Word</strong>
           </div>
        </div>

        <button class="btn btn-primary" onclick="Game.goToScoreboard()">See Scoreboard</button>
    </div>

    <!-- 7. Scoreboard -->
    <div id="screen-scoreboard" class="screen">
        <h1 class="text-c text-gold mb-2">LEADERBOARD</h1>
        <div class="content-area" id="scoreboard-list" style="justify-content: flex-start; text-align: center;">
            <!-- Scores -->
        </div>
        
        <button class="btn btn-primary" onclick="Game.setupNextRound()">Next Round</button>
        <button class="btn" onclick="Game.resetGame()">New Game</button>
    </div>
</div>

<script>
/**
 * ODDINARY GAME ENGINE
 * Refined and Updated
 */

// --- Word Data ---
const WORD_PAIRS = [
    ["Sun", "Moon"], ["Pizza", "Burger"], ["Coffee", "Tea"], ["Ocean", "Pool"], ["Car", "Bus"], 
    ["Dog", "Cat"], ["Apple", "Orange"], ["Pen", "Pencil"], ["Chair", "Sofa"], ["Shoes", "Socks"], 
    ["Guitar", "Violin"], ["Winter", "Summer"], ["Rain", "Snow"], ["Book", "Magazine"], 
    ["Laptop", "Tablet"], ["Train", "Subway"], ["Football", "Basketball"], ["King", "Prince"], 
    ["Ghost", "Vampire"], ["Robot", "Alien"], ["Doctor", "Nurse"]
];

// --- State ---
const State = {
    players: [], // { name: "Anto", score: 0, id: 1 }
    playerOrder: [], 
    roles: {}, 
    words: { common: "", odd: "" },
    currentOddPlayerId: null,
    votes: {}, 
    round: 0,
    config: { shuffle: false, timer: false },
    stepIndex: 0,
    pendingVoteTarget: null // For confirmation
};

const $ = (id) => document.getElementById(id);
const Screens = ['landing', 'setup', 'reveal', 'discuss', 'voting', 'results', 'scoreboard'];
let shouldPreventRefresh = true;

// --- Safety: Prevent Refresh ---
window.addEventListener('beforeunload', (e) => {
    // Only prompt if game is in progress
    if(shouldPreventRefresh && (State.round > 0)) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// --- Game Controller ---
const Game = {
    init: () => {
        // Default 3 players
        State.players = [
            { id: 101, name: "Player 1", score: 0 },
            { id: 102, name: "Player 2", score: 0 },
            { id: 103, name: "Player 3", score: 0 }
        ];
    },

    showScreen: (name) => {
        Screens.forEach(s => $(`screen-${s}`).classList.remove('active'));
        $(`screen-${name}`).classList.add('active');
        window.scrollTo(0,0);
    },

    toggleRules: () => {
        const modal = $('modal-rules');
        modal.classList.toggle('open');
    },

    // --- Setup Phase ---
    goToSetup: () => {
        Game.showScreen('setup');
        Game.renderSetupInputs();
    },

    goHome: () => Game.showScreen('landing'),

    addPlayer: () => {
        if(State.players.length >= 30) return alert("Max 30 players!");
        const nextNum = State.players.length + 1;
        State.players.push({ id: Date.now(), name: `Player ${nextNum}`, score: 0 });
        Game.renderSetupInputs();
    },

    removePlayer: (index) => {
        if(State.players.length <= 3) return alert("Min 3 players required!");
        State.players.splice(index, 1);
        Game.renderSetupInputs();
    },
    
    // Clear default name logic
    onInputFocus: (el) => {
        if(el.value.startsWith('Player')) {
            el.dataset.oldVal = el.value;
            el.value = '';
        }
    },

    onInputBlur: (el, index) => {
        if(el.value.trim() === '') {
            // Restore if empty
            el.value = el.dataset.oldVal || `Player ${index + 1}`;
            State.players[index].name = el.value;
        }
    },

    renderSetupInputs: () => {
        const list = $('players-list');
        list.innerHTML = "";
        
        State.players.forEach((p, idx) => {
            const grp = document.createElement('div');
            grp.className = "input-group";
            
            grp.innerHTML = `
                <input type="text" 
                       value="${p.name}" 
                       oninput="State.players[${idx}].name = this.value"
                       onfocus="Game.onInputFocus(this)"
                       onblur="Game.onInputBlur(this, ${idx})"
                >
                <button class="btn btn-icon btn-danger" onclick="Game.removePlayer(${idx})">
                   <svg viewBox="0 0 24 24"><path d="M5 11h14v2H5z"/></svg>
                </button>
            `;
            list.appendChild(grp);
        });
    },

    startGame: () => {
        // Validation: use defaults if empty
        State.players.forEach((p, i) => {
            if(!p.name.trim()) p.name = `Player ${i+1}`;
        });
        
        if(State.players.length < 3) return alert("Min 3 players!");

        // Configs
        State.config.shuffle = $('setting-shuffle').checked;
        State.config.timer = $('setting-timer').checked;

        Game.setupNextRound();
    },

    setupNextRound: () => {
        State.round++;
        const pair = WORD_PAIRS[Math.floor(Math.random() * WORD_PAIRS.length)];
        
        if(Math.random() > 0.5) {
            State.words.common = pair[0];
            State.words.odd = pair[1];
        } else {
             State.words.common = pair[1];
             State.words.odd = pair[0];
        }

        const pIds = State.players.map(p => p.id);
        const oddIndex = Math.floor(Math.random() * pIds.length);
        State.currentOddPlayerId = pIds[oddIndex];
        
        State.roles = {};
        pIds.forEach(id => {
            State.roles[id] = (id === State.currentOddPlayerId) ? 'odd' : 'common';
        });

        State.playerOrder = [...pIds];
        if(State.config.shuffle) {
            State.playerOrder.sort(() => Math.random() - 0.5);
        }

        State.stepIndex = 0;
        State.votes = {};
        Game.showRevealScreen();
    },

    // --- Reveal Phase ---
    showRevealScreen: () => {
        const playerId = State.playerOrder[State.stepIndex];
        const player = State.players.find(p => p.id === playerId);
        
        $('reveal-player-name').innerText = player.name;
        $('reveal-counter').innerText = `Player ${State.stepIndex + 1}/${State.players.length}`;
        $('word-card').classList.remove('flipped');
        
        const role = State.roles[playerId];
        $('secret-word-display').innerText = (role === 'odd') ? State.words.odd : State.words.common;
        
        // Button Logic: Check if Last Player
        const nextBtn = $('btn-next-player');
        nextBtn.classList.add('hidden');
        
        if(State.stepIndex === State.players.length - 1) {
             nextBtn.innerHTML = `Discussion`;
        } else {
             nextBtn.innerHTML = `Hide & Pass`;
        }
        
        Game.showRevealCounter = true;
        Game.showScreen('reveal');
    },

    flipCard: () => {
        const card = $('word-card');
        if(card.classList.contains('flipped')) return;
        
        card.classList.add('flipped');
        setTimeout(() => {
            $('btn-next-player').classList.remove('hidden');
        }, 800);
    },

    nextReveal: () => {
        State.stepIndex++;
        if(State.stepIndex < State.players.length) {
            Game.showRevealScreen();
        } else {
            Game.startDiscussion();
        }
    },

    // --- Discussion ---
    startDiscussion: () => {
        Game.showScreen('discuss');
        const timerDisplay = $('timer-display');
        
        if(State.config.timer) {
            timerDisplay.classList.remove('hidden');
            let timeLeft = 180; 
            const tick = () => {
                const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
                const s = (timeLeft % 60).toString().padStart(2,'0');
                timerDisplay.innerText = `${m}:${s}`;
                if(timeLeft > 0) {
                    timeLeft--;
                    State.timerIdx = setTimeout(tick, 1000); 
                }
            };
            tick();
        } else {
            timerDisplay.classList.add('hidden');
        }
    },

    // --- Voting ---
    startVoting: () => {
        clearTimeout(State.timerIdx);
        State.stepIndex = 0;
        State.votes = {};
        Game.showVotingScreen();
    },

    showVotingScreen: () => {
        const voterId = State.playerOrder[State.stepIndex];
        const voter = State.players.find(p => p.id === voterId);
        
        $('voter-name').innerText = voter.name;
        
        const list = $('voting-list');
        list.innerHTML = "";
        
        State.players.forEach(p => {
            if(p.id === voterId) return; 
            
            const btn = document.createElement('BUTTON');
            btn.className = "btn";
            btn.innerText = p.name; 
            // Change to ask for confirmation
            btn.onclick = () => Game.askConfirmVote(voterId, p.id);
            list.appendChild(btn);
        });
        
        Game.showScreen('voting');
    },

    askConfirmVote: (voterId, targetId) => {
        State.pendingVoteTarget = targetId;
        const targetName = State.players.find(p => p.id === targetId).name;
        $('confirm-vote-name').innerText = targetName;
        $('modal-vote-confirm').classList.add('open');
    },

    confirmVote: () => {
        const voterId = State.playerOrder[State.stepIndex];
        const targetId = State.pendingVoteTarget;
        
        $('modal-vote-confirm').classList.remove('open');
        Game.submitVote(voterId, targetId);
    },

    cancelVote: () => {
        $('modal-vote-confirm').classList.remove('open');
        State.pendingVoteTarget = null;
    },

    submitVote: (voterId, targetId) => {
        State.votes[voterId] = targetId;
        State.stepIndex++;
        
        if(State.stepIndex < State.players.length) {
            Game.showVotingScreen();
        } else {
            Game.calculateResults();
        }
    },

    // --- Results ---
    calculateResults: () => {
        const voteCounts = {}; 
        let maxVotes = 0;
        
        State.players.forEach(p => { voteCounts[p.id] = 0; });
        
        Object.values(State.votes).forEach(targetId => {
            voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
            if(voteCounts[targetId] > maxVotes) maxVotes = voteCounts[targetId];
        });
        
        const oddPlayerCaught = (voteCounts[State.currentOddPlayerId] === maxVotes && maxVotes > 0);
        
        const oddId = State.currentOddPlayerId;
        const oddPlayer = State.players.find(p => p.id === oddId);
        
        if(oddPlayerCaught) {
            Object.entries(State.votes).forEach(([voterId, targetId]) => {
                if(targetId == oddId) {
                     State.players.find(p => p.id == voterId).score += 10;
                }
            });
        } else {
            State.players.find(p => p.id === oddId).score += 15;
            if(voteCounts[oddId] === 0) {
                 State.players.find(p => p.id === oddId).score += 5; 
            }
            Object.entries(State.votes).forEach(([voterId, targetId]) => {
                if(targetId == oddId) {
                    State.players.find(p => p.id == voterId).score += 5;
                }
            });
        }
        
        Game.renderResults(voteCounts, oddPlayer, oddPlayerCaught);
    },
    
    renderResults: (voteCounts, oddPlayer, wasCaught) => {
        const area = $('results-area');
        area.innerHTML = "";
        
        // Always show "VOTE RESULTS"
        const statusH = document.createElement('h2');
        // REMOVED COLOR LOGIC
        // statusH.className = wasCaught ? 'text-primary' : 'text-danger'; 
        statusH.innerText = "VOTE RESULTS"; 
        statusH.style.marginBottom = "20px";
        statusH.style.color = "white"; // Force White
        area.appendChild(statusH);
        
        const sortedPlayers = [...State.players].sort((a,b) => voteCounts[b.id] - voteCounts[a.id]);
        
        sortedPlayers.forEach(p => {
             const count = voteCounts[p.id];
             
             const wrap = document.createElement('div');
             wrap.style.width = "100%";
             wrap.style.marginBottom = "15px";
             
             wrap.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center;">
                    <span>${p.name}</span>
                </div>
                <div class="vote-bar-container">
                    <div class="vote-bar-fill" style="width: 0%;" data-w="${(count/State.players.length)*100}%"></div>
                    <span class="vote-count-text">${count} votes</span>
                </div>
             `;
             area.appendChild(wrap);
        });
        
        // Imposter Reveal Text
        $('imposter-reveal-text').innerText = `${oddPlayer.name} was the Imposter!`;
        
        $('res-common-word').innerText = State.words.common;
        $('res-odd-word').innerText = State.words.odd;
        
        Game.showScreen('results');
        
        setTimeout(() => {
            document.querySelectorAll('.vote-bar-fill').forEach(bar => {
                bar.style.width = bar.getAttribute('data-w');
            });
        }, 100);
    },
    
    goToScoreboard: () => {
        const area = $('scoreboard-list');
        area.innerHTML = "";
        
        const sorted = [...State.players].sort((a,b) => b.score - a.score);
        
        sorted.forEach((p, idx) => {
            const item = document.createElement('div');
            item.className = "list-item";
            if(idx === 0) item.style.borderColor = "var(--accent-gold)";
            
            item.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span style="font-weight:900; color:var(--text-muted); width:30px; text-align:right; margin-right:10px;">#${idx+1}</span>
                    <span style="font-size:1.2rem; font-weight:bold;">${p.name}</span>
                </div>
                <span class="text-primary" style="font-weight:900; font-size:1.2rem;">${p.score}</span>
            `;
            area.appendChild(item);
        });
        
        Game.showScreen('scoreboard');
    },
    
    resetGame: () => {
        shouldPreventRefresh = false;
        location.reload();
    }
};

Game.init();
</script>
</body>
</html>
